<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 利用 raspberrypi 搭建下载机 · Lei's blog</title><meta name="description" content="利用 raspberrypi 搭建下载机 - Zhang Lei"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Lei's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/leizhang233" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/zhanglei12345" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">利用 raspberrypi 搭建下载机</h1><div class="post-info">Aug 19, 2018</div><div class="post-content"><p>此篇文章介绍利用 raspberrypi 搭建下载机。</p>
<a id="more"></a>
<h2 id="aria2"><a href="#aria2" class="headerlink" title="aria2"></a>aria2</h2><p><a href="https://aria2.github.io/manual/en/html/aria2c.html?highlight=session#" target="_blank" rel="noopener">aria2</a> is a utility for downloading files.</p>
<p>安装 aria2：<br><code>sudo apt-get install aria2</code></p>
<p>aria2 运行的时候需要两个文件，并且需要我们手动配置，一个是配置文件 <strong>aria2.conf</strong>，保存配置，另一个是 <strong>aria2.session</strong>，要不每次 aria2 关闭的时候，之前下载的进度都没了。</p>
<p>生成 token (外网连接加上验证)：<br><a href="https://pyjwt.readthedocs.io/en/latest/" target="_blank" rel="noopener">PyJWT</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install pyjwt</span><br><span class="line">python</span><br><span class="line">&gt;&gt;&gt; import jwt</span><br><span class="line">&gt;&gt;&gt; jwt.encode(&#123;<span class="string">'some'</span>: <span class="string">'payload'</span>&#125;, <span class="string">'secret'</span>, algorithm=<span class="string">'HS256'</span>, headers=&#123;<span class="string">'name'</span> : <span class="string">'zhanglei'</span>&#125;)</span><br></pre></td></tr></table></figure></p>
<p>会生成一个 token，将添加于 aria2.conf 中。</p>
<p>创建 aria2.conf 和 aria2.session：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> </span><br><span class="line">mkdir .aria2</span><br><span class="line"><span class="built_in">cd</span> .aria2   </span><br><span class="line">touch aria2.session  </span><br><span class="line">vim aria2.conf</span><br></pre></td></tr></table></figure></p>
<p>aria2.conf 中添加如下内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#文件保存目录 </span></span><br><span class="line">dir=/home/pi/Downloads</span><br><span class="line"><span class="comment">#禁用IPv6, 默认:false</span></span><br><span class="line"><span class="built_in">disable</span>-ipv6=<span class="literal">true</span>  </span><br><span class="line"><span class="comment">#启用RPC, 默认:false</span></span><br><span class="line"><span class="built_in">enable</span>-rpc=<span class="literal">true</span>  </span><br><span class="line"><span class="comment">#允许所有来源, 默认:false</span></span><br><span class="line">rpc-allow-origin-all=<span class="literal">true</span>  </span><br><span class="line"><span class="comment">#允许外部访问, 默认:false，false的话只监听本地端口</span></span><br><span class="line">rpc-listen-all=<span class="literal">true</span>  </span><br><span class="line"><span class="comment">#设置的RPC授权令牌,上面生成的 token</span></span><br><span class="line">rpc-secret= token</span><br><span class="line"><span class="comment">#RPC监听端口, 端口被占用时可以修改, 默认:6800</span></span><br><span class="line"><span class="comment">#rpc-listen-port=6800  </span></span><br><span class="line"><span class="comment">#允许断点续传</span></span><br><span class="line"><span class="built_in">continue</span>=<span class="literal">true</span>  </span><br><span class="line"><span class="comment">#从会话文件中读取下载任务</span></span><br><span class="line">input-file=/home/pi/.aria2/aria2.session </span><br><span class="line"><span class="comment">#在aria2退出时保存‘错误/未完成’的下载任务到会话文件</span></span><br><span class="line">save-session=/home/pi/.aria2/aria2.session </span><br><span class="line"><span class="comment">#最大同时下载任务数</span></span><br><span class="line">max-concurrent-downloads=3</span><br><span class="line"><span class="comment">#整体下载速度限制, 运行时可修改, 默认:0,0意味着没限制</span></span><br><span class="line"><span class="comment">#max-overall-download-limit=0</span></span><br><span class="line"><span class="comment">#单个任务下载速度限制, 默认:0</span></span><br><span class="line"><span class="comment">#max-download-limit=0</span></span><br><span class="line"><span class="comment">#整体上传速度限制, 运行时可修改, 默认:0</span></span><br><span class="line"><span class="comment">#max-overall-upload-limit=0</span></span><br><span class="line"><span class="comment">#单个任务上传速度限制, 默认:0</span></span><br><span class="line"><span class="comment">#max-upload-limit=0</span></span><br><span class="line"><span class="comment">#同服务器连接数，默认:1</span></span><br><span class="line">max-connection-per-server=5</span><br><span class="line"><span class="comment">#最小文件分片大小, 下载线程数上限取决于能分出多少片, 对于小文件重要，默认：20M</span></span><br><span class="line"><span class="comment">#min-split-size=20M</span></span><br><span class="line"><span class="comment">#单个文件最大线程数，默认：5</span></span><br><span class="line"><span class="comment">#split=5</span></span><br></pre></td></tr></table></figure></p>
<p>启动：<br><code>sudo aria2c --conf-path=&quot;/home/pi/.aria2/aria2.conf&quot; -D</code></p>
<p>给 aria2c 设置启动服务:<br><code>sudo vim /etc/init.d/aria2c</code></p>
<p>文件中写入下列内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">### BEGIN INIT INFO</span></span><br><span class="line"><span class="comment"># Provides:          aria2</span></span><br><span class="line"><span class="comment"># Required-Start:    $remote_fs $network</span></span><br><span class="line"><span class="comment"># Required-Stop:     $remote_fs $network</span></span><br><span class="line"><span class="comment"># Default-Start:     2 3 4 5</span></span><br><span class="line"><span class="comment"># Default-Stop:      0 1 6</span></span><br><span class="line"><span class="comment"># Short-Description: Aria2 Downloader</span></span><br><span class="line"><span class="comment">### END INIT INFO</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line"> </span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"Starting aria2c"</span></span><br><span class="line">sudo -u pi aria2c --conf-path=/home/pi/.aria2/aria2.conf -D</span><br><span class="line"><span class="comment">#把上面的两个pi换成你的用户名</span></span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line"> </span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"Shutting down aria2c "</span></span><br><span class="line">killall aria2c</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line"> </span><br><span class="line">killall aria2c</span><br><span class="line">sudo -u pi aria2c --conf-path=/home/pi/.aria2/aria2.conf -D</span><br><span class="line"><span class="comment">#把上面的两个pi换成你的用户名</span></span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure></p>
<p>调整权限：<br><code>sudo chmod 755 /etc/init.d/aria2c</code></p>
<p>开机自启：<br><code>sudo update-rc.d aria2c defaults</code></p>
<h2 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h2><p>安装：<br><code>sudo apt-get install nginx</code></p>
<p>配置站点属性：<br><code>sudo vim  /etc/nginx/sites-availiable/default</code><br>修改：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"> 	<span class="attribute">listen</span> <span class="number">81</span>;</span><br><span class="line">	<span class="comment">#listen [::]:80 default_server;</span></span><br><span class="line">	<span class="attribute">root</span> /var/www/html;</span><br><span class="line">	<span class="attribute">server_name</span> pi.com;</span><br><span class="line">	...</span><br></pre></td></tr></table></figure></p>
<p>启动：<br><code>sudo /etc/init.d/nginx start</code></p>
<h2 id="webui-aria2"><a href="#webui-aria2" class="headerlink" title="webui-aria2"></a>webui-aria2</h2><p>通过web访问的方式控制树莓派的下载<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/www</span><br><span class="line">sudo git <span class="built_in">clone</span> https://github.com/ziahamza/webui-aria2.git</span><br><span class="line">sudo mv webui-aria2/* html/</span><br></pre></td></tr></table></figure></p>
<p>内网中浏览器直接访问树莓派IP地址:端口号即可观看到效果，记得在webui界面的设置-连接设置-密码令牌中要输入配置文件aria2.conf 中的 token。</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fjlsle8k95j30zf0n9gnt.jpg" alt=""></p>
<h2 id="花生壳"><a href="#花生壳" class="headerlink" title="花生壳"></a>花生壳</h2><p>可穿透内网的动态域名解析软件，实现外网来访问 webui-aria2 界面进行下载的管理。</p>
<p>本地下载树莓派版本的花生壳：<br><a href="http://hsk.oray.com/download/" target="_blank" rel="noopener">官网</a></p>
<p>将下载后的软件包上传到树莓派上。</p>
<p>在树莓派上 cd 到安装包的目录，接下来进行安装：<br><code>sudo dpkg -i phddns_rapi_3.0.1.armhf.deb</code></p>
<p>安装成功后，将显示此树莓派唯一的 SN 码、默认密码以及远程管理地址。</p>
<p>配置花生壳：<br>浏览器进入<a href="http://b.oray.com/" target="_blank" rel="noopener">花生壳远程管理页面</a>，输入 SN 码和默认密码 admin，首次登陆需要进行初始化，重设密码<br>，填写手机。默认内置账户只有公网版服务，所以需要开通内网穿透功能。之后要添加两个映射，ip 对应着树莓派的局域网 ip (此ip 要进入路由器的管理界面，将树莓派设置为静态ip地址获取方式，设置时，mac地址为树莓派 wlan0 的 HWaddr),端口分别对应着 webui 的 81 端口( nginx 配置的端口)和 RPC 的 6800 端口(默认)。</p>
<p>外网中浏览器访问花生壳分配的对应内网 81 端口的外网 ip 地址和端口，记得在webui界面的的设置-连接设置-端口设置为花生壳分配的 RPC 端口，设置-连接设置-密码令牌中要输入配置文件 aria2.conf 中的 token。</p>
<p>其他：<br>终端输入 phddns 回车后，可以看到扩展的功能。</p>
<p><img src="https://ws3.sinaimg.cn/large/006tKfTcly1fjlsmfw7zxj30zd0j577p.jpg" alt=""></p>
<h2 id="samba"><a href="#samba" class="headerlink" title="samba"></a>samba</h2><p>文件共享服务，让局域网内可以访问。</p>
<p>安装 samba：<br><code>sudo apt-get install samba samba-common-bin</code></p>
<p>备份一份配置文件：<br><code>sudo cp /etc/samba/smb.conf /etc/samba/smb.conf.bak</code></p>
<p>编辑配置文件：<br><code>sudo vim /etc/samba/smb.conf</code></p>
<p>下面的配置是让用户可以访问自己的 home 目录。<br>开启用户认证：找到####### Authentication #######,在后面添加一行 <code>security = user</code>，来使用户进行验证，禁止匿名登录。<br>配置用户：在[homes]节中，把 read only = yes 改为 read only = no 。</p>
<p>重启 samba 服务：<br>sudo /etc/init.d/samba restart</p>
<p>添加账户到共享文件夹，设置一个密码：<br>sudo smbpasswd -a pi</p>
<p>之后在 mac 上 Finder 中共享的会看到 raspberrypi，点击连接身份，以注册用户的身份登录。</p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fjlsmxdgarj30mv0cq770.jpg" alt=""></p>
<h2 id="VNC"><a href="#VNC" class="headerlink" title="VNC"></a>VNC</h2><p>远程桌面。</p>
<p>安装 VNC：<br><code>sudo apt-get install tightvncserver</code></p>
<p>启动服务器：<br><code>vncserver :1</code><br>之后会提示创建密码，先是控制密码，然后是仅查看密码。</p>
<p>然后就可以从别的电脑的 VNC Viewer 访问了，连接时候会提示连接不安全，忽略就好。(自己本地通过192.168.1.102:5901)</p>
<p>给 VNC 建立启动服务：<br><code>sudo vim /etc/init.d/tightvncserver</code></p>
<p>文件中写入下列内容：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">### BEGIN INIT INFO</span></span><br><span class="line"><span class="comment"># Provides: tightvncserver</span></span><br><span class="line"><span class="comment"># Required-Start: $syslog $remote_fs $network</span></span><br><span class="line"><span class="comment"># Required-Stop: $syslog $remote_fs $network</span></span><br><span class="line"><span class="comment"># Default-Start: 2 3 4 5</span></span><br><span class="line"><span class="comment"># Default-Stop: 0 1 6</span></span><br><span class="line"><span class="comment"># Short-Description: Starts VNC Server on system start.</span></span><br><span class="line"><span class="comment"># Description: Starts tight VNC Server. Script written by James Swineson.</span></span><br><span class="line"><span class="comment">### END INIT INFO</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /etc/init.d/tightvncserver</span></span><br><span class="line">VNCUSER=<span class="string">'pi'</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line"> start)</span><br><span class="line"> su <span class="variable">$VNCUSER</span> -c <span class="string">'/usr/bin/tightvncserver :1 -geometry 1920x1080'</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">"Starting TightVNC Server for <span class="variable">$VNCUSER</span>"</span></span><br><span class="line"> ;;</span><br><span class="line"> stop)</span><br><span class="line"> pkill Xtightvnc</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">"TightVNC Server stopped"</span></span><br><span class="line"> ;;</span><br><span class="line"> *)</span><br><span class="line"> <span class="built_in">echo</span> <span class="string">"Usage: /etc/init.d/tightvncserver &#123;start|stop&#125;"</span></span><br><span class="line"> <span class="built_in">exit</span> 1</span><br><span class="line"> ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure></p>
<p>调整权限：<br><code>sudo chmod 755 /etc/init.d/tightvncserver</code></p>
<p>开机自启：<br><code>sudo update-rc.d tightvncserver defaults</code></p>
<p>重启树莓派：<br><code>sudo reboot</code></p>
<p><img src="https://ws4.sinaimg.cn/large/006tKfTcly1fjlsndftufj31330mkkan.jpg" alt=""></p>
<h2 id="预留问题"><a href="#预留问题" class="headerlink" title="预留问题"></a>预留问题</h2><ol>
<li><p>花生版免费版连接不是很稳定，并且每月只有1G的免费流量，尝试通过其他方式实现内网穿透；</p>
</li>
<li><p>由于需求量不是很大，只是初步玩一玩，所以我没挂载大容量的移动硬盘，下载机的存储空间用的还是树莓派的32G启动盘；</p>
</li>
<li><p>aria2目前还没装扩展。 </p>
</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2018/08/19/在Telegram收发微信消息/" class="prev">PREV</a><a href="/2018/08/19/我的24/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'https-zhanglei12345-github-io';
var disqus_identifier = '2018/08/19/利用raspberrypi搭建下载机/';
var disqus_title = '利用 raspberrypi 搭建下载机';
var disqus_url = 'http://yoursite.com/2018/08/19/利用raspberrypi搭建下载机/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//https-zhanglei12345-github-io.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2018 <a href="http://yoursite.com">Zhang Lei</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>